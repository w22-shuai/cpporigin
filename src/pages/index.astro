---
// ==========================================
// 1. åç«¯é€»è¾‘ (åªåœ¨ Cloudflare è¿è¡Œ)
// ==========================================

import type { D1Database } from '@cloudflare/workers-types';

// è·å–è¿è¡Œæ—¶ç¯å¢ƒ
const runtime = Astro.locals.runtime;

// å˜é‡å®šä¹‰
let db: D1Database | null = null;
let errorMsg = "";
let debugEnv = "";
let dataList: any[] = [];
let totalCount = 0;

// å°è¯•è·å–æ•°æ®åº“ç»‘å®š
// ä¼˜å…ˆæ‰¾ cpporigin (è¿™æ˜¯ä½  wrange.json é‡Œé…çš„)
if (runtime && runtime.env) {
	debugEnv = Object.keys(runtime.env).join(", "); // ç”¨äºè°ƒè¯•æ˜¾ç¤ºæœ‰å“ªäº›å˜é‡
	if (runtime.env.cpporigin) {
		db = runtime.env.cpporigin as D1Database;
	}
}

// è·å–åˆ†é¡µå‚æ•°
const page = parseInt(Astro.url.searchParams.get('page') || '1');
const pageSize = 10;
const offset = (page - 1) * pageSize;

// æ‰§è¡Œæ•°æ®åº“æŸ¥è¯¢
if (db) {
	try {
		// ã€é‡è¦ã€‘æŸ¥è¯¢é€»è¾‘
		// 1. SELECT * FROM cpporigin -> ä½ çš„è¡¨å
		// 2. ORDER BY id DESC -> æŒ‰ ID å€’åºï¼ˆæœ€æ–°åœ¨å‰ï¼‰ï¼Œå¦‚æœä½ çš„è¡¨æ²¡ id å­—æ®µï¼Œæ”¹æˆ key æˆ– rowid
		// 3. LIMIT ? OFFSET ? -> åˆ†é¡µ
		const result = await db.prepare(
			"SELECT * FROM cpporigin ORDER BY id DESC LIMIT ? OFFSET ?"
		).bind(pageSize, offset).all();

		dataList = result.results;

		// æŸ¥è¯¢æ€»æ•°ç”¨äºåˆ†é¡µ
		const countRes = await db.prepare("SELECT COUNT(*) as count FROM cpporigin").first();
		totalCount = countRes.count as number;

	} catch (e: any) {
		errorMsg = "SQLæ‰§è¡Œé”™è¯¯: " + e.message;
		// æ™ºèƒ½æç¤ºï¼šå¦‚æœæŠ¥é”™æ²¡è¿™åˆ—ï¼Œæç¤ºç”¨æˆ·
		if (e.message.includes("no such column")) {
			errorMsg += " (æç¤º: è¯·æ£€æŸ¥ä½ çš„è¡¨é‡Œæ˜¯å¦æœ‰ id æˆ– created_at å­—æ®µï¼Ÿ)";
		}
	}
} else {
	// åªæœ‰åœ¨ runtime å­˜åœ¨ä½†æ‰¾ä¸åˆ° cpporigin æ—¶æ‰æŠ¥é”™
	if (runtime) {
		errorMsg = `é”™è¯¯: æ‰¾ä¸åˆ°ç»‘å®š 'env.cpporigin'ã€‚å½“å‰å¯ç”¨ç»‘å®š: [${debugEnv}]`;
	} else {
		// æœ¬åœ°å¼€å‘ç¯å¢ƒæ²¡ mock æ—¶ä¼šè¿›è¿™é‡Œï¼Œä¸ç®—é”™è¯¯
		errorMsg = "æœ¬åœ°é¢„è§ˆæ¨¡å¼ï¼šæœªè¿æ¥çœŸå®æ•°æ®åº“ (è¯·éƒ¨ç½²åæŸ¥çœ‹)";
	}
}

// è®¡ç®—åˆ†é¡µ
const totalPages = Math.ceil(totalCount / pageSize);
const hasPrev = page > 1;
const hasNext = page < totalPages;

// æ—¥æœŸæ ¼å¼åŒ–å·¥å…·
function formatTime(val: any) {
	if (!val) return 'Unknown Date';
	// å¦‚æœæ˜¯æ—¶é—´æˆ³æ•°å­—
	if (typeof val === 'number') {
		return new Date(val * 1000).toISOString().split('T')[0];
	}
	return val; // å¦‚æœæ˜¯å­—ç¬¦ä¸²ç›´æ¥è¿”å›
}
---

<!-- ========================================== -->
<!-- 2. å‰ç«¯ç•Œé¢ (HTML) -->
<!-- ========================================== -->

<html lang="zh-cn">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>C++ æºç æŸ¥è¯¢ç³»ç»Ÿ</title>
</head>
<body>

<header class="navbar">
	<div class="container nav-inner">
		<div class="brand">
			<span class="icon">ğŸ§¬</span> CPP<span>Origin</span>
		</div>
		<div class="meta">
			Status: {db ? "Online ğŸŸ¢" : "Offline ğŸ”´"}
		</div>
	</div>
</header>

<main class="container">

	<!-- é”™è¯¯æç¤ºæ¡† -->
	{errorMsg && (
		<div class="alert-box">
			<strong>âš ï¸ ç³»ç»Ÿæç¤ºï¼š</strong> {errorMsg}
			<br/>
			<small>è¯·ç¡®ä¿ wrangler.json ä¸­çš„ binding å« cpporiginï¼Œä¸”è¡¨åæ­£ç¡®ã€‚</small>
		</div>
	)}

	<!-- åˆ—è¡¨åŒºåŸŸ -->
	<div class="repo-list">
		{dataList.map((item) => (
			<div class="repo-card">
				<div class="card-header">
					<div class="file-title">
						<span class="file-icon">ğŸ“„</span>
						<!-- ä¼˜å…ˆæ˜¾ç¤º keyï¼Œå¦‚æœæ²¡æœ‰ key æ˜¾ç¤º titleï¼Œå†æ²¡æœ‰æ˜¾ç¤º Unknown -->
						<h3>{item.key || item.title || "Unknown_File"}</h3>
					</div>
					<div class="file-meta">
						ID: {item.id} &nbsp;|&nbsp;
						{formatTime(item.created_at || item.date)}
					</div>
				</div>

				<div class="code-preview">
					<!-- æ˜¾ç¤º value æˆ– content -->
					<pre><code>{item.value || item.content || "// ç©ºå†…å®¹"}</code></pre>
				</div>
			</div>
		))}
	</div>

	<!-- ç©ºçŠ¶æ€ -->
	{dataList.length === 0 && !errorMsg && (
		<div class="empty-state">
			<p>ğŸ“­ æ•°æ®åº“é‡Œæ²¡æœ‰æ•°æ®ï¼Œæˆ–è€…è¡¨åä¸å¯¹ã€‚</p>
		</div>
	)}

	<!-- åˆ†é¡µæŒ‰é’® -->
	<div class="pagination">
		<a href={hasPrev ? `?page=${page - 1}` : '#'} class={`btn ${!hasPrev ? 'disabled' : ''}`}>
			&laquo; ä¸Šä¸€é¡µ
		</a>
		<span class="page-count">Page {page} of {totalPages || 1}</span>
		<a href={hasNext ? `?page=${page + 1}` : '#'} class={`btn ${!hasNext ? 'disabled' : ''}`}>
			ä¸‹ä¸€é¡µ &raquo;
		</a>
	</div>

</main>

<footer class="footer">
	<p>Powered by Cloudflare D1 & Astro</p>
</footer>

</body>
</html>

<!-- ========================================== -->
<!-- 3. æ ·å¼ (CSS) -->
<!-- ========================================== -->
<style>
	:root {
		--bg: #0d1117;       /* èƒŒæ™¯é»‘ */
		--card: #161b22;     /* å¡ç‰‡é»‘ */
		--border: #30363d;   /* è¾¹æ¡†ç° */
		--text: #c9d1d9;     /* æ–‡å­—ç™½ */
		--blue: #58a6ff;     /* é“¾æ¥è“ */
		--green: #238636;    /* æŒ‰é’®ç»¿ */
	}

	body {
		background-color: var(--bg);
		color: var(--text);
		font-family: Consolas, "Courier New", monospace; /* å…¨å±€ç­‰å®½å­—ä½“ */
		margin: 0;
		line-height: 1.5;
	}

	.container {
		max-width: 900px;
		margin: 0 auto;
		padding: 0 1rem;
	}

	/* å¯¼èˆªæ  */
	.navbar {
		background: var(--card);
		border-bottom: 1px solid var(--border);
		padding: 1rem 0;
		margin-bottom: 2rem;
	}
	.nav-inner {
		display: flex;
		justify-content: space-between;
		align-items: center;
	}
	.brand { font-size: 1.5rem; font-weight: bold; color: var(--text); }
	.brand span { color: var(--blue); }
	.meta { font-size: 0.85rem; color: #8b949e; }

	/* é”™è¯¯æç¤º */
	.alert-box {
		background: #3c1618;
		border: 1px solid #ff7b72;
		color: #ff7b72;
		padding: 1rem;
		border-radius: 6px;
		margin-bottom: 1.5rem;
		font-family: sans-serif;
	}

	/* å¡ç‰‡åˆ—è¡¨ */
	.repo-list { display: flex; flex-direction: column; gap: 1rem; }

	.repo-card {
		background: var(--card);
		border: 1px solid var(--border);
		border-radius: 6px;
		overflow: hidden;
	}

	.card-header {
		background: #21262d;
		padding: 0.75rem 1rem;
		border-bottom: 1px solid var(--border);
		display: flex;
		justify-content: space-between;
		align-items: center;
	}
	.file-title h3 {
		margin: 0;
		font-size: 1rem;
		color: var(--blue);
		display: inline-block;
	}
	.file-meta { font-size: 0.8rem; color: #8b949e; }

	/* ä»£ç é¢„è§ˆ */
	.code-preview {
		padding: 1rem;
		background: #0d1117;
		overflow-x: auto;
	}
	.code-preview pre { margin: 0; }
	.code-preview code { color: #8b949e; font-size: 0.9rem; }

	/* åˆ†é¡µ */
	.pagination {
		display: flex;
		justify-content: center;
		align-items: center;
		margin: 2rem 0;
		gap: 1rem;
	}
	.btn {
		background: var(--card);
		border: 1px solid var(--border);
		color: var(--blue);
		padding: 5px 15px;
		border-radius: 6px;
		text-decoration: none;
		transition: 0.2s;
	}
	.btn:hover:not(.disabled) { background: #30363d; }
	.btn.disabled { opacity: 0.5; pointer-events: none; color: #8b949e; }

	.empty-state { text-align: center; padding: 3rem; color: #8b949e; }
	.footer { text-align: center; padding: 2rem; color: #484f58; font-size: 0.8rem; border-top: 1px solid var(--border); }
</style>