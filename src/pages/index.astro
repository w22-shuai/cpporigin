---
import type { D1Database } from '@cloudflare/workers-types';

const runtime = Astro.locals.runtime;
let db: D1Database | null = null;
let errorMessage = "";
let codes = [];
let totalCount = 0;

// 【关键修改】这里直接使用截图里显示的名称 cpporigin
if (runtime && runtime.env && runtime.env.cpporigin) {
	db = runtime.env.cpporigin as D1Database;
}

const page = parseInt(Astro.url.searchParams.get('page') || '1');
const pageSize = 10;
const offset = (page - 1) * pageSize;

// 只有当数据库连接成功时才查询
if (db) {
	try {
		// 注意：这里表名是 cpporigin，如果你的表名是 cpp_origin，请修改 SQL 里的 FROM
		const result = await db.prepare(
			"SELECT * FROM cpporigin ORDER BY key DESC LIMIT ? OFFSET ?"
		).bind(pageSize, offset).all();

		let codes = result.results as any[];

		const countResult = await db.prepare("SELECT COUNT(*) as count FROM cpporigin").first();
		totalCount = countResult.count as number;

	} catch (e: any) {
		errorMessage = "查询错误: " + e.message;
		// 如果报错说 no such table: cpporigin，说明表名不对，试试改成 cpp_origin
		if (e.message.includes("no such table")) {
			errorMessage += " (提示: 请检查 SQL 里的表名是否正确，可能是 cpp_origin？)";
		}
	}
} else {
	// 如果还是 undefined，说明 runtime.env.cpporigin 没拿到
	errorMessage = "错误: 无法获取数据库绑定 env.cpporigin。请确认已重新部署。";
	if (runtime && runtime.env) {
		errorMessage += " 当前可用变量: " + Object.keys(runtime.env).join(", ");
	}
}

// ... 下面的分页逻辑和 HTML 不用变 ...
const totalPages = Math.ceil(totalCount / pageSize);
const hasPrev = page > 1;
const hasNext = page < totalPages;
function formatDate(timestamp: number) {
	if (!timestamp) return '';
	return new Date(timestamp * 1000).toISOString().split('T')[0];
}
---