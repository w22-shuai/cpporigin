---
// ==========================================
// 1. åç«¯é€»è¾‘ (Server Side)
// ==========================================

const db = Astro.locals.runtime.env.cpporigin;

// è·å–é¡µç 
const page = parseInt(Astro.url.searchParams.get('page') || '1');
const pageSize = 10;
const offset = (page - 1) * pageSize;

// å®šä¹‰æ•°æ®ç»“æ„
// ã€æ³¨æ„ã€‘å¦‚æœä½ æ•°æ®åº“çš„åˆ—åè¿˜æ˜¯ key/valueï¼Œè¯·æŠŠä¸‹é¢çš„ title æ”¹ä¸º keyï¼Œcontent æ”¹ä¸º value
type SourceCode = {
	id: number;
	title: string;   // å¯¹åº”æ–‡ä»¶åæˆ– Key
	content: string; // å¯¹åº” C++ æºç 
	created_at: number;
};

let codes: SourceCode[] = [];
let totalCount = 0;
let errorMessage = "";

try {
	// æŸ¥è¯¢åˆ—è¡¨
	// å‡è®¾ä½ è¿˜æ˜¯ç”¨ created_at æ’åºã€‚å¦‚æœæ˜¯æ—§è¡¨ï¼Œè®°å¾—æ”¹å› ORDER BY key
	const result = await db.prepare(
		"SELECT * FROM cpporigin ORDER BY key DESC LIMIT ? OFFSET ?"
	).bind(pageSize, offset).all();

	codes = result.results as unknown as SourceCode[];

	// æŸ¥è¯¢æ€»æ•°
	const countResult = await db.prepare("SELECT COUNT(*) as count FROM cpporigin").first();
	totalCount = countResult.count as number;

} catch (e: any) {
	errorMessage = "æŸ¥è¯¢é”™è¯¯: " + e.message;
}

// åˆ†é¡µè®¡ç®—
const totalPages = Math.ceil(totalCount / pageSize);
const hasPrev = page > 1;
const hasNext = page < totalPages;

// ç®€å•çš„æ—¥æœŸ
function formatDate(timestamp: number) {
	if (!timestamp) return '';
	return new Date(timestamp * 1000).toISOString().split('T')[0]; // æ˜¾ç¤ºä¸º YYYY-MM-DD
}
---

<!-- ========================================== -->
<!-- 2. å‰ç«¯ç•Œé¢ (HTML) -->
<!-- ========================================== -->

<html lang="zh-cn">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>C++ æºç åº“</title>
</head>
<body>

<header class="navbar">
	<div class="container nav-content">
		<div class="brand">
			<span class="icon">ğŸ’»</span> CPP<span>Origin</span>
		</div>
		<div class="stats">
			å…±æ”¶å½• {totalCount} ä¸ªæ–‡ä»¶
		</div>
	</div>
</header>

<main class="container">

	<!-- é”™è¯¯æç¤º -->
	{errorMessage && (
		<div class="alert error">
			âš ï¸ {errorMessage}
		</div>
	)}

	<!-- ä»£ç åˆ—è¡¨ -->
	<div class="code-list">
		{codes.map((item) => (
			<div class="code-card">
				<div class="card-header">
					<div class="file-info">
						<span class="file-icon">ğŸ“„</span>
						<h2 class="file-name">{item.title || "Unknown.cpp"}</h2>
					</div>
					<span class="file-date">{formatDate(item.created_at)}</span>
				</div>

				<div class="code-preview">
					{/* pre æ ‡ç­¾ä¿ç•™ä»£ç æ ¼å¼ï¼Œåªæ˜¾ç¤ºå‰5è¡Œä½œä¸ºé¢„è§ˆ */}
					<pre><code>{item.content ? item.content.substring(0, 200) + '...' : '// ç©ºæ–‡ä»¶'}</code></pre>
				</div>

				<div class="card-footer">
					<span class="lang-tag">C++</span>
					<!-- è¿™é‡Œçš„é“¾æ¥åªæ˜¯ç¤ºä¾‹ï¼Œéœ€è¦ä½ åˆ›å»º /post/[id].astro æ¥æ˜¾ç¤ºè¯¦æƒ… -->
					<a href={`/post/${item.id}`} class="view-btn">æŸ¥çœ‹å®Œæ•´æºç </a>
				</div>
			</div>
		))}
	</div>

	<!-- ç©ºçŠ¶æ€ -->
	{codes.length === 0 && !errorMessage && (
		<div class="empty-state">
			<code>404 Not Found: Database is empty.</code>
		</div>
	)}

	<!-- åˆ†é¡µ -->
	<div class="pagination">
		<a href={hasPrev ? `?page=${page - 1}` : '#'} class={`btn ${!hasPrev ? 'disabled' : ''}`}>
			&lt; Prev
		</a>
		<span class="page-num">{page} / {totalPages || 1}</span>
		<a href={hasNext ? `?page=${page + 1}` : '#'} class={`btn ${!hasNext ? 'disabled' : ''}`}>
			Next &gt;
		</a>
	</div>

</main>

<footer class="footer">
	<p>CPP Source Query System &bull; Powered by Cloudflare D1</p>
</footer>

</body>
</html>

<!-- ========================================== -->
<!-- 3. æ ·å¼ (CSS) -->
<!-- ========================================== -->
<style>
	:root {
		--bg-body: #0d1117;       /* GitHub æš—è‰²èƒŒæ™¯ */
		--bg-card: #161b22;       /* å¡ç‰‡æ·±è‰² */
		--border: #30363d;        /* è¾¹æ¡†è‰² */
		--text-main: #c9d1d9;     /* æ–‡å­—ç°ç™½ */
		--text-muted: #8b949e;    /* å¼±æ–‡å­— */
		--accent: #58a6ff;        /* é“¾æ¥è“ */
		--code-bg: #0d1117;       /* ä»£ç å—èƒŒæ™¯ */
	}

	body {
		background-color: var(--bg-body);
		color: var(--text-main);
		font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans", Helvetica, Arial, sans-serif;
		margin: 0;
	}

	/* å®¹å™¨ */
	.container {
		max-width: 900px;
		margin: 0 auto;
		padding: 0 1rem;
	}

	/* é¡¶éƒ¨å¯¼èˆª */
	.navbar {
		background: var(--bg-card);
		border-bottom: 1px solid var(--border);
		padding: 1rem 0;
		margin-bottom: 2rem;
	}
	.nav-content {
		display: flex;
		justify-content: space-between;
		align-items: center;
	}
	.brand {
		font-size: 1.5rem;
		font-weight: bold;
		color: var(--text-main);
		font-family: monospace;
	}
	.brand span { color: var(--accent); }
	.stats {
		font-size: 0.9rem;
		color: var(--text-muted);
		font-family: monospace;
	}

	/* åˆ—è¡¨å¸ƒå±€ */
	.code-list {
		display: flex;
		flex-direction: column;
		gap: 1rem;
	}

	/* ä»£ç å¡ç‰‡ */
	.code-card {
		background: var(--bg-card);
		border: 1px solid var(--border);
		border-radius: 6px;
		overflow: hidden;
	}

	.card-header {
		padding: 0.8rem 1rem;
		background: #21262d; /* ç¨å¾®äº®ä¸€ç‚¹ */
		border-bottom: 1px solid var(--border);
		display: flex;
		justify-content: space-between;
		align-items: center;
	}
	.file-info {
		display: flex;
		align-items: center;
		gap: 0.5rem;
	}
	.file-name {
		margin: 0;
		font-size: 1rem;
		font-family: monospace; /* æ–‡ä»¶åç”¨ç­‰å®½å­—ä½“ */
		color: var(--accent);
	}
	.file-date {
		font-size: 0.8rem;
		color: var(--text-muted);
	}

	/* ä»£ç é¢„è§ˆåŒº */
	.code-preview {
		padding: 1rem;
		background: var(--code-bg);
		overflow-x: auto;
	}
	.code-preview pre {
		margin: 0;
	}
	.code-preview code {
		font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
		font-size: 0.9rem;
		color: var(--text-muted);
		line-height: 1.5;
	}

	/* å¡ç‰‡åº•éƒ¨ */
	.card-footer {
		padding: 0.8rem 1rem;
		border-top: 1px solid var(--border);
		display: flex;
		justify-content: space-between;
		align-items: center;
	}
	.lang-tag {
		font-size: 0.75rem;
		color: var(--text-muted);
		border: 1px solid var(--border);
		padding: 2px 8px;
		border-radius: 10px;
	}
	.view-btn {
		font-size: 0.9rem;
		color: var(--text-main);
		text-decoration: none;
		background: #21262d;
		padding: 5px 12px;
		border: 1px solid var(--border);
		border-radius: 6px;
		transition: 0.2s;
	}
	.view-btn:hover {
		background: #30363d;
		border-color: #8b949e;
	}

	/* åˆ†é¡µæŒ‰é’® */
	.pagination {
		display: flex;
		justify-content: center;
		align-items: center;
		margin: 2rem 0;
		gap: 1rem;
	}
	.btn {
		background: var(--bg-card);
		border: 1px solid var(--border);
		color: var(--accent);
		padding: 0.5rem 1rem;
		border-radius: 6px;
		text-decoration: none;
	}
	.btn:hover:not(.disabled) { background: #21262d; }
	.btn.disabled { color: var(--text-muted); pointer-events: none; opacity: 0.5; }
	.page-num { font-family: monospace; color: var(--text-main); }

	/* é”™è¯¯ä¸ç©ºçŠ¶æ€ */
	.alert.error {
		background: #3c1618;
		color: #ff7b72;
		padding: 1rem;
		border: 1px solid #ff7b72;
		border-radius: 6px;
		margin-bottom: 1rem;
	}
	.empty-state {
		text-align: center;
		padding: 4rem;
		color: var(--text-muted);
	}
	.footer {
		text-align: center;
		padding: 2rem;
		color: var(--text-muted);
		font-size: 0.8rem;
		border-top: 1px solid var(--border);
		margin-top: 2rem;
	}
</style>