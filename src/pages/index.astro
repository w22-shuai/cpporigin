---
// ==========================================
// æ–‡ä»¶è·¯å¾„: src/pages/index.astro
// ==========================================

import type { D1Database } from '@cloudflare/workers-types';

// 1. åˆå§‹åŒ–ç¯å¢ƒä¸å˜é‡
const runtime = Astro.locals.runtime;
let db: D1Database | null = null;
let errorMsg = "";
let dataList: any[] = [];
let totalCount = 0;

// 2. è¿æ¥ D1 æ•°æ®åº“
if (runtime && runtime.env) {
	if (runtime.env.cpporigin) {
		db = runtime.env.cpporigin as D1Database;
	}
}

// 3. å¤„ç†åˆ†é¡µå‚æ•°
const page = parseInt(Astro.url.searchParams.get('page') || '1');
const pageSize = 10;
const offset = (page - 1) * pageSize;

// 4. æ‰§è¡ŒæŸ¥è¯¢
if (db) {
	try {
		// æŸ¥è¯¢åˆ—è¡¨ (æŒ‰ key å€’åºï¼Œæˆ–è€…æŒ‰ id å€’åº)
		const result = await db.prepare(
			"SELECT * FROM cpporigin ORDER BY key DESC LIMIT ? OFFSET ?"
		).bind(pageSize, offset).all();

		dataList = result.results;

		// æŸ¥è¯¢æ€»æ•°
		const countRes = await db.prepare("SELECT COUNT(*) as count FROM cpporigin").first();
		totalCount = countRes?.count as number || 0;

	} catch (e: any) {
		errorMsg = "æ•°æ®åº“æŸ¥è¯¢å‡ºé”™: " + e.message;
	}
} else {
	// æœ¬åœ°å¼€å‘å¦‚æœæ²¡æœ‰ mock D1ï¼Œæˆ–è€…æœªéƒ¨ç½²ï¼Œä¼šæç¤ºè¿™ä¸ª
	if (!runtime) {
		errorMsg = "æœ¬åœ°é¢„è§ˆæ¨¡å¼ï¼šæœªæ£€æµ‹åˆ° Cloudflare Runtime (è¯·éƒ¨ç½²åæµ‹è¯•)";
	} else {
		errorMsg = "é”™è¯¯ï¼šæ‰¾ä¸åˆ°åä¸º 'cpporigin' çš„æ•°æ®åº“ç»‘å®š";
	}
}

// 5. è®¡ç®—åˆ†é¡µé€»è¾‘
const totalPages = Math.ceil(totalCount / pageSize);
const hasPrev = page > 1;
const hasNext = page < totalPages;

// 6. è¾…åŠ©å‡½æ•°ï¼šæ—¶é—´æ ¼å¼åŒ–
function formatTime(val: any) {
	if (!val) return '-';
	if (typeof val === 'number') return new Date(val * 1000).toISOString().split('T')[0];
	return val;
}
---

<html lang="zh-cn">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>C++ æºç åº“</title>
</head>
<body>

<header class="navbar">
	<div class="container nav-inner">
		<div class="brand">ğŸ§¬ CPP<span>Origin</span></div>
		<div class="status">{db ? "ğŸŸ¢ Online" : "ğŸ”´ Offline"}</div>
	</div>
</header>

<main class="container">

	<!-- é”™è¯¯æç¤º -->
	{errorMsg && <div class="alert-box">{errorMsg}</div>}

	<!-- åˆ—è¡¨å±•ç¤º -->
	<div class="repo-list">
		{dataList.map((item) => (
			<div class="repo-card">
				<div class="card-header">
					<div class="file-info">
						<span class="icon">ğŸ“„</span>
						<!-- æ ¸å¿ƒä¿®æ”¹ï¼šè¿™é‡Œæ·»åŠ äº†è·³è½¬é“¾æ¥ -->
						<h3>
							<a href={`/source/${item.key}`} class="file-link">
								{item.key || "Unknown_File"}
							</a>
						</h3>
					</div>
					<div class="file-meta">
						<span>ID: {item.id}</span>
						<span class="date">{formatTime(item.created_at || item.date)}</span>
					</div>
				</div>

				<div class="code-preview">
					<!-- é¢„è§ˆåªæ˜¾ç¤ºå‰ 200 ä¸ªå­—ç¬¦ -->
					<pre><code>{(item.value || item.content || "").slice(0, 200)}...</code></pre>
				</div>
			</div>
		))}
	</div>

	<!-- ç©ºçŠ¶æ€ -->
	{dataList.length === 0 && !errorMsg && (
		<div class="empty-state">æš‚æ— æ•°æ®</div>
	)}

	<!-- åˆ†é¡µå¯¼èˆª -->
	<div class="pagination">
		<a href={hasPrev ? `?page=${page - 1}` : '#'} class={`btn ${!hasPrev ? 'disabled' : ''}`}>ä¸Šä¸€é¡µ</a>
		<span class="page-num">{page} / {totalPages || 1}</span>
		<a href={hasNext ? `?page=${page + 1}` : '#'} class={`btn ${!hasNext ? 'disabled' : ''}`}>ä¸‹ä¸€é¡µ</a>
	</div>

</main>

<footer class="footer">Cloudflare D1 & Astro Demo</footer>

</body>
</html>

<style>
	/* å…¨å±€å˜é‡ä¸é‡ç½® */
	:root {
		--bg: #0d1117;
		--card-bg: #161b22;
		--border: #30363d;
		--text-main: #c9d1d9;
		--text-muted: #8b949e;
		--link: #58a6ff;
		--btn-bg: #21262d;
	}
	body { background: var(--bg); color: var(--text-main); font-family: Consolas, monospace; margin: 0; }
	a { text-decoration: none; }

	.container { max-width: 900px; margin: 0 auto; padding: 0 1rem; }

	/* é¡¶éƒ¨å¯¼èˆª */
	.navbar { border-bottom: 1px solid var(--border); background: var(--card-bg); padding: 1rem 0; margin-bottom: 2rem; }
	.nav-inner { display: flex; justify-content: space-between; align-items: center; }
	.brand { font-size: 1.2rem; font-weight: bold; }
	.brand span { color: var(--link); }
	.status { font-size: 0.8rem; color: var(--text-muted); }

	/* åˆ—è¡¨å¡ç‰‡ */
	.repo-list { display: flex; flex-direction: column; gap: 1rem; }
	.repo-card { border: 1px solid var(--border); border-radius: 6px; background: var(--card-bg); overflow: hidden; }

	.card-header {
		padding: 0.8rem 1rem;
		border-bottom: 1px solid var(--border);
		background: #21262d;
		display: flex;
		justify-content: space-between;
		align-items: center;
	}

	.file-info h3 { margin: 0; display: inline; font-size: 1rem; }
	.file-link { color: var(--link); font-weight: 600; }
	.file-link:hover { text-decoration: underline; color: #79c0ff; }
	.icon { margin-right: 0.5rem; }

	.file-meta { font-size: 0.8rem; color: var(--text-muted); display: flex; gap: 1rem; }

	/* ä»£ç é¢„è§ˆåŒº */
	.code-preview { padding: 1rem; background: #0d1117; font-size: 0.85rem; color: var(--text-muted); }
	.code-preview pre { margin: 0; white-space: pre-wrap; word-break: break-all; }

	/* åˆ†é¡µ */
	.pagination { display: flex; justify-content: center; gap: 1rem; margin: 2rem 0; align-items: center; }
	.btn { padding: 5px 15px; border: 1px solid var(--border); color: var(--link); border-radius: 6px; background: var(--btn-bg); transition: 0.2s; }
	.btn:hover:not(.disabled) { background: #30363d; }
	.btn.disabled { opacity: 0.5; cursor: not-allowed; color: var(--text-muted); }

	.alert-box { border: 1px solid #ff7b72; color: #ff7b72; padding: 1rem; border-radius: 6px; margin-bottom: 1rem; }
	.empty-state, .footer { text-align: center; color: var(--text-muted); padding: 2rem; }
	.footer { border-top: 1px solid var(--border); font-size: 0.8rem; }
</style>