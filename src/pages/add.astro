---
// src/pages/add.astro

const db = Astro.locals.runtime.env.cpporigin;

// 获取现有分类
const { results: categories } = await db.prepare('SELECT id, maintitle FROM cppOriginIndex').all();

let errorMessage = "";


const runtime = Astro.locals.runtime;
const env = runtime?.env;
const timenow = Math.floor(Date.now() / 1000);




try{
const userToken = Astro.cookies.get("cf_token_kasada")?.value;
let serverToken = null;

if (env?.checkidentity) {
    serverToken = await env.checkidentity.get("cookie");
}

if (!userToken || !serverToken || userToken !== serverToken) {
    Astro.cookies.delete("cf_token_kasada", { path: "/" });
    return Astro.redirect("/login"); // 确保这里重定向路径是你想要的
}}catch(e){
    return Astro.redirect("/login"); // 确保这里重定向路径是你想要的
}



// 处理表单提交
if (Astro.request.method === "POST") {
  try {
    const formData = await Astro.request.formData();
    const selectionType = formData.get("selection_type"); // 'existing' or 'new'
    const title = formData.get("title");
    const content = formData.get("content");

    let categoryId = formData.get("category_id");
    const newCategoryName = formData.get("new_category_name");

    if (!title || !content) {
      throw new Error("标题和内容不能为空");
    }
    if (selectionType === 'new') {
        // 如果选了新建，但没填名字，抛出错误
        if (!newCategoryName || newCategoryName.toString().trim() === "") {
            throw new Error("请填写新分类的大标题名称");
        }

        // 插入新分类
        const insertCat = await db.prepare('INSERT INTO cppOriginIndex (maintitle) VALUES (?) RETURNING id')
            .bind(newCategoryName)
            .first();
        categoryId = insertCat.id;
    } else {
        // 如果是现有分类，确保 ID 存在
        if (!categoryId) {
             throw new Error("请选择一个分类");
        }
    }
    await db.prepare('INSERT INTO cppOriginContent (category_id, title, content) VALUES (?, ?, ?)')
        .bind(categoryId, title, content)
        .run();

    return Astro.redirect("/");

  } catch (error) {
    errorMessage = error.message || "提交失败，请重试";
  }
}
---

<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>添加新记录</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
</head>
<body>
    <div class="background-glow"></div>

    <main class="container">
        <header>
            <a href="/" class="back-link">← 返回首页</a>
            <h1>添加 <span class="text-gradient">记录</span></h1>
        </header>

        <!-- 如果有错误信息，显示红色提示框 -->
        {errorMessage && (
            <div class="error-banner">
                ⚠️ {errorMessage}
            </div>
        )}

        <form method="POST" class="form-card" id="addForm">

            <section class="form-section">
                <h2 class="section-title">所属分类</h2>

                <div class="category-grid">
                    <!-- 现有分类 -->
                    {categories.map((cat) => (
                        <label class="radio-card">
                            <input type="radio" name="category_id" value={cat.id} class="cat-radio" required>
                            <span class="card-inner">
                                <span class="cat-id">[{cat.id}]</span>
                                <span class="cat-name">{cat.maintitle}</span>
                            </span>
                        </label>
                    ))}

                    <!-- 新建分类 -->
                    <label class="radio-card new-option">
                        <input type="radio" name="category_id" value="new" class="cat-radio" required>
                        <span class="card-inner">
                            <span class="cat-icon">+</span>
                            <span class="cat-name">新建分类</span>
                        </span>
                    </label>
                </div>

                <!-- 隐藏字段，用于告诉后端这是新建还是已有 -->
                <input type="hidden" name="selection_type" id="selection_type" value="">

                <!-- 新建分类输入框 (初始隐藏) -->
                <div id="new-cat-input-group" class="input-group" style="display: none;">
                    <label for="new_category_name" style="color:var(--primary);">新分类名称</label>
                    <input type="text" name="new_category_name" id="new_category_name" placeholder="例如: 内存模型">
                </div>
            </section>

            <hr class="divider">

            <section class="form-section">
                <div class="input-group">
                    <label for="title">小标题 / 知识点</label>
                    <input type="text" name="title" placeholder="例如: atomic原子操作" required>
                </div>

                <div class="input-group">
                    <label for="content">详细内容</label>
                    <textarea name="content" rows="8" placeholder="Markdown 内容..." required></textarea>
                </div>
            </section>

            <button type="submit" class="submit-btn">
                <span>提交记录</span>
                <span class="arrow">→</span>
            </button>
        </form>
    </main>

    <!-- 脚本：控制输入框显示与必填属性 -->
    <script>
        const radios = document.querySelectorAll('.cat-radio');
        const newCatGroup = document.getElementById('new-cat-input-group');
        const newCatInput = document.getElementById('new_category_name');
        const selectionType = document.getElementById('selection_type');

        radios.forEach(radio => {
            radio.addEventListener('change', (e) => {
                if (e.target.value === 'new') {
                    // 1. 显示输入框
                    newCatGroup.style.display = 'flex';
                    // 2. 设为必填 (关键修复)
                    newCatInput.setAttribute('required', 'true');
                    // 3. 更新隐藏字段
                    selectionType.value = 'new';
                    // 4. 自动聚焦
                    newCatInput.focus();
                } else {
                    // 1. 隐藏输入框
                    newCatGroup.style.display = 'none';
                    // 2. 移除必填 (关键修复)
                    newCatInput.removeAttribute('required');
                    // 3. 更新隐藏字段
                    selectionType.value = 'existing';
                }
            });
        });
    </script>

    <style>
        :root {
            --bg-color: #0f172a;
            --card-bg: rgba(30, 41, 59, 0.7);
            --card-border: rgba(148, 163, 184, 0.1);
            --primary: #38bdf8;
            --secondary: #818cf8;
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --input-bg: rgba(15, 23, 42, 0.6);
            --error-color: #f87171;
        }

        /* 基础样式复用 */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Inter', system-ui, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            min-height: 100vh;
        }

        .background-glow {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at 50% 0%, rgba(56, 189, 248, 0.1), transparent 50%);
            z-index: -1;
            pointer-events: none;
        }

        .container { max-width: 800px; margin: 0 auto; padding: 3rem 1.5rem; }

        header { text-align: center; margin-bottom: 2rem; }
        h1 { font-size: 2.5rem; font-weight: 800; margin-top: 1rem; }
        .text-gradient {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .back-link { color: var(--text-muted); text-decoration: none; transition: color 0.2s; }
        .back-link:hover { color: var(--primary); }

        /* 错误提示框 */
        .error-banner {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid var(--error-color);
            color: #fca5a5;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            text-align: center;
            font-weight: 600;
        }

        .form-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 16px;
            padding: 2.5rem;
            backdrop-filter: blur(10px);
        }

        .section-title { font-size: 0.9rem; color: var(--text-muted); margin-bottom: 1rem; text-transform: uppercase; font-weight: 700; }

        /* 分类网格 */
        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .radio-card input { display: none; }
        .card-inner {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 1rem;
            background: rgba(15, 23, 42, 0.4);
            border: 1px solid var(--card-border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            height: 100%;
        }

        /* 选中状态 */
        .radio-card input:checked + .card-inner {
            background: rgba(56, 189, 248, 0.15);
            border-color: var(--primary);
            box-shadow: 0 0 10px rgba(56, 189, 248, 0.2);
        }
        .new-option .card-inner { border-style: dashed; }

        /* 输入框通用 */
        .input-group { margin-bottom: 1.5rem; display: flex; flex-direction: column; gap: 0.5rem; animation: fadeIn 0.3s; }
        .input-group label { font-size: 0.9rem; color: var(--text-muted); font-weight: 600; }

        input[type="text"], textarea {
            width: 100%;
            background: var(--input-bg);
            border: 1px solid var(--card-border);
            border-radius: 8px;
            padding: 0.8rem;
            color: white;
            font-size: 1rem;
            font-family: inherit;
        }

        textarea { font-family: 'JetBrains Mono', monospace; }

        input:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.1);
        }

        .divider { border: 0; height: 1px; background: var(--card-border); margin: 2rem 0; }

        .submit-btn {
            width: 100%; padding: 1rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border: none; border-radius: 8px;
            color: white; font-weight: 700; cursor: pointer;
            display: flex; justify-content: center; gap: 0.5rem;
            transition: opacity 0.2s;
        }
        .submit-btn:hover { opacity: 0.9; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</body>
</html>