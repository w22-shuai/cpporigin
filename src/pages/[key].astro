---
// ==========================================
// æ–‡ä»¶è·¯å¾„: src/pages/source/[key].astro
// ==========================================

import type { D1Database } from '@cloudflare/workers-types';

// 1. è·å– URL å‚æ•°
const { key } = Astro.params;

// 2. åˆå§‹åŒ–æ•°æ®åº“
const runtime = Astro.locals.runtime;
let db: D1Database | null = null;
let item: any = null;
let errorMsg = "";

if (runtime && runtime.env && runtime.env.cpporigin) {
    db = runtime.env.cpporigin as D1Database;
}

// 3. æ ¹æ® Key æŸ¥è¯¢è¯¦æƒ…
if (db && key) {
    try {
        // ä½¿ç”¨ WHERE key = ? è¿›è¡Œç²¾ç¡®æŸ¥æ‰¾
        item = await db.prepare("SELECT * FROM cpporigin WHERE key = ?").bind(key).first();
    } catch (e: any) {
        errorMsg = "æŸ¥è¯¢å¤±è´¥: " + e.message;
    }
}

// 4. è¾…åŠ©å‡½æ•°
function formatTime(val: any) {
    if (typeof val === 'number') return new Date(val * 1000).toISOString().split('T')[0];
    return val;
}
---

<html lang="zh-cn">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{key} - æºç è¯¦æƒ…</title>
</head>
<body>

<div class="container">

    <!-- é¢åŒ…å±‘å¯¼èˆª -->
    <nav class="breadcrumb">
        <a href="/">ğŸ  é¦–é¡µåˆ—è¡¨</a>
        <span class="sep">/</span>
        <span class="curr">{key}</span>
    </nav>

    <!-- é”™è¯¯å¤„ç† -->
    {errorMsg && <div class="alert-box">{errorMsg}</div>}

    {!item && !errorMsg && (
            <div class="alert-box">âš ï¸ æœªæ‰¾åˆ°æ–‡ä»¶ï¼š<strong>{key}</strong></div>
    )}

    <!-- æºç è¯¦æƒ…å¡ç‰‡ -->
    {item && (
            <main class="detail-card">
                <div class="detail-header">
                    <h1>{item.key}</h1>
                    <div class="detail-meta">
                        <span>File ID: {item.id}</span>
                        <span>Created: {formatTime(item.created_at || item.date)}</span>
                    </div>
                </div>

                <div class="code-content">
                    <!-- æ˜¾ç¤ºå®Œæ•´ä»£ç  -->
                    <pre><code id="source-code">{item.value || item.content}</code></pre>
                </div>

                <div class="detail-footer">
                    <button id="copy-btn" class="copy-btn">ğŸ“‹ å¤åˆ¶å…¨éƒ¨ä»£ç </button>
                </div>
            </main>
    )}

</div>

<!-- ç®€å•çš„å¤åˆ¶è„šæœ¬ -->
<script>
    const btn = document.getElementById('copy-btn');
    const codeBlock = document.getElementById('source-code');

    if(btn && codeBlock) {
        btn.addEventListener('click', () => {
            navigator.clipboard.writeText(codeBlock.innerText).then(() => {
                btn.innerText = "âœ… å·²å¤åˆ¶";
                setTimeout(() => btn.innerText = "ğŸ“‹ å¤åˆ¶å…¨éƒ¨ä»£ç ", 2000);
            });
        });
    }
</script>

</body>
</html>

<style>
    :root {
        --bg: #0d1117;
        --card-bg: #161b22;
        --border: #30363d;
        --text: #c9d1d9;
        --blue: #58a6ff;
        --green: #238636;
    }

    body {
        background-color: var(--bg);
        color: var(--text);
        font-family: Consolas, monospace;
        margin: 0;
        padding: 2rem 0;
    }

    .container { max-width: 1000px; margin: 0 auto; padding: 0 1rem; }

    /* å¯¼èˆªæ ·å¼ */
    .breadcrumb { margin-bottom: 1.5rem; font-size: 1rem; }
    .breadcrumb a { color: var(--blue); text-decoration: none; }
    .breadcrumb a:hover { text-decoration: underline; }
    .breadcrumb .sep { margin: 0 0.5rem; color: #8b949e; }
    .breadcrumb .curr { color: #fff; font-weight: bold; }

    /* è¯¦æƒ…å¡ç‰‡ */
    .detail-card {
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: 8px;
        overflow: hidden;
    }

    .detail-header {
        background: #21262d;
        padding: 1.5rem;
        border-bottom: 1px solid var(--border);
    }
    .detail-header h1 { margin: 0 0 0.5rem 0; color: #fff; font-size: 1.5rem; }
    .detail-meta { color: #8b949e; font-size: 0.9rem; display: flex; gap: 1.5rem; }

    /* ä»£ç åŒºåŸŸ */
    .code-content {
        background: #0d1117;
        padding: 1.5rem;
        overflow-x: auto;
    }
    .code-content pre { margin: 0; }
    .code-content code { font-family: 'Courier New', Courier, monospace; line-height: 1.5; font-size: 0.95rem; }

    /* åº•éƒ¨æŒ‰é’® */
    .detail-footer {
        padding: 1rem;
        border-top: 1px solid var(--border);
        text-align: right;
        background: #161b22;
    }
    .copy-btn {
        background: var(--green);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        font-family: inherit;
        font-size: 0.9rem;
        transition: 0.2s;
    }
    .copy-btn:hover { background: #2ea043; }

    .alert-box {
        border: 1px solid #ff7b72;
        color: #ff7b72;
        padding: 1.5rem;
        border-radius: 6px;
        background: #3c1618;
        text-align: center;
    }
</style>